---
title: "00-Data-Processing-Example"
output: html_notebook
---

In this notebook we create some examples of processing the data for the analysis of accessibility. Particularly, we're interested in spatial interpolationo of the population for small areas.

## Preliminaries

Load packages used in the notebook:
```{r message = FALSE}
library(pycno)
library(readr)
library(rgrass7)
library(sf)
library(tidyverse)
```

Load data files:
```{r}
load("hamilton_cma.RData")
load("hamilton_da_2016.RData")
```

These two data files are simple features with the dissemination areas according to the 2016 Census, and the boundary of Hamilton CMA.
```{r}
ggplot() +
  geom_sf(data = hamilton_cma)
```

```{r}
ggplot() +
  geom_sf(data = hamilton_da_2016)
```

Read Sobi service area:
```{r}
sobi_service <- st_read("SoBi_Service_Areas.shp")
```

Bounding box of population in serviced areas:
```{r}
bounding_box <- st_bbox(sobi_service %>%
                          st_buffer(500))
```

Plot:
```{r}
ggplot() + 
  geom_sf(data = hamilton_da_2016,
          fill = NA,
          color = "lightgray") + 
  geom_sf(data = sobi_service,
          fill = NA) +
  geom_sf(data = st_as_sfc(bounding_box),
          linetype = "dashed",
          fill = NA)
```

Adjust bounding box to remove service are in park to the east:
```{r}
bounding_box[3] <- 597200
```

Plot:
```{r}
ggplot() + 
  geom_sf(data = hamilton_da_2016,
          fill = NA,
          color = "lightgray") + 
  geom_sf(data = sobi_service,
          fill = NA) +
  geom_sf(data = st_as_sfc(bounding_box),
          linetype = "dashed",
          fill = NA)
```

Read parks:
```{r}
parks <- st_read("Parks.shp")
```

Read cemeteries:
```{r}
cemeteries <- st_read("Cemeteries.shp")
```

Read environmentally sensitive areas:
```{r}
esa <- st_read("Environmentally_Sensitive_Areas_Boundaries.shp")
```

Project the Hamilton DA zones to the same projection of the SoBi Service Areas:
```{r}
hamilton_da_2016 <- st_transform(hamilton_da_2016, crs = st_crs(sobi_service))
```

Extract DAs in service areas:
```{r}
hamilton_da_sobi <- hamilton_da_2016[st_as_sfc(bounding_box),]
```

Extract parks in service areas:
```{r}
parks_sobi <- st_crop(parks, st_as_sfc(bounding_box))
```

Extract cemeteries in service areas:
```{r}
cemeteries_sobi <- st_crop(cemeteries, st_as_sfc(bounding_box))
```

Extract environmentally sensitive areas in service areas:
```{r}
esa_sobi <- st_crop(esa, st_as_sfc(bounding_box))
```

Read population table (2016 Census of Population, Population and Dwelling counts):
```{r}
population_da_2016 <- read_csv("T1901EN.csv") %>%
  transmute(DA = factor(`Geographic code`), population = `Population, 2016`)
```

Join population table to DAs in service areas:
```{r}
hamilton_da_sobi <- hamilton_da_sobi %>%
  left_join(population_da_2016, by = "DA")
```

Plot population:
```{r}
ggplot() +
  geom_sf(data = hamilton_da_sobi,
          aes(fill = population),
          color = NA) +
  geom_sf(data = sobi_service,
          fill = NA) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1)
```

Plot "Green" spaces:
```{r}
ggplot() +
  geom_sf(data = parks_sobi,
          fill = "blue") +
  geom_sf(data = cemeteries_sobi,
          fill = "gray") +
  geom_sf(data = esa_sobi,
          fill = "green") +
  geom_sf(data = sobi_service,
          fill = NA,
          color = "black") +
  geom_sf(data = hamilton_da_sobi,
          fill = NA,
          color = "gray") +
  scale_fill_distiller(palette = "YlOrRd", direction = 1)
```

Union of the "green space" features:
```{r}
parks_sobi <- st_combine(parks_sobi)
cemeteries_sobi <- st_combine(cemeteries_sobi)
esa_sobi <- st_combine(esa_sobi)
```

Check that the topology is valid:
```{r}
st_is_valid(parks_sobi)
st_is_valid(cemeteries_sobi)
st_is_valid(esa_sobi)
```

Make valid:
```{r}
parks_sobi <- st_make_valid(parks_sobi)
esa_sobi <- st_make_valid(esa_sobi)
```

Remove the parks from the DAs (use `st_difference()`):
```{r}
hamilton_da_sobi_clean <- st_difference(hamilton_da_sobi, parks_sobi)
```

Remove the cemeteries from the DAs (use `st_difference()`):
```{r}
hamilton_da_sobi_clean <- st_difference(hamilton_da_sobi_clean, cemeteries_sobi)
```

Remove environmentally sensitive areas from the DAs (use `st_difference()`):
```{r}
hamilton_da_sobi_clean <- st_difference(hamilton_da_sobi, esa_sobi)
```

Plot the new DAs (minus green) and compare to original DAs:
```{r}
ggplot() +
  geom_sf(data = hamilton_da_sobi_clean,
          color = NA,
          fill = "blue") +
  geom_sf(data = hamilton_da_sobi,
          fill = NA,
          color = "black")
```

Pycnophylactic interpolation needs a `SpatialPolygonsDataFrame` object. Convert the simple features object:
```{r}
hamilton_da_sobi_clean.sp <- as(hamilton_da_sobi_clean, "Spatial")
```

Extract the population from the spatial object:
```{r}
pop <- hamilton_da_sobi_clean.sp@data$population
```

Pycnophylactic interpolation:
```{r}
filter <- stats::filter # Important! `filter()` should be from `stats`, not `dplyer`
interpolated_pop <- pycno(x = hamilton_da_sobi_clean.sp, pops = pop, celldim = 50)
```

Convert to pixels and then simple features:
```{r}
interpolated_pop.pix <- as(interpolated_pop, "SpatialPixelsDataFrame")
interpolated_pop <- data.frame(population = interpolated_pop.pix$dens, 
                               x = interpolated_pop.pix@coords[,1],
                               y = interpolated_pop.pix@coords[,2]) %>%
  st_as_sf(coords = c("x", "y"),
           crs = st_crs(hamilton_da_sobi))
```

Check the population totals:
```{r}
sum(hamilton_da_sobi_clean$population)
sum(interpolated_pop$population)
```

Plot interpolated population:
```{r}
ggplot() + 
  geom_sf(data = interpolated_pop,
          aes(color = population)) +
  scale_color_distiller(palette = "YlOrRd", 
                        direction = 1) +
  geom_sf(data = hamilton_da_sobi,
          fill = NA,
          color = "lightgray") + 
  geom_sf(data = sobi_service,
          fill = NA)
```

Extract population cells in the service area (and buffer)
```{r}
interpolated_pop_clean <- interpolated_pop[sobi_service %>% st_buffer(500),]
```

Plot interpolated population again:
```{r}
ggplot() + 
  geom_sf(data = interpolated_pop_clean,
          aes(color = population)) +
  geom_sf(data = sobi_service,
          fill = NA) +
  scale_color_distiller(palette = "YlOrRd", 
                        direction = 1)
```

